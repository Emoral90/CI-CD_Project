# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains jobs that will run my tests
  test:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install requests pytest

      - name: Start local API server
        run: |
          python3 server.py &
          sleep 3 # Wait for server to start up

      - name: Run API tests
        run: pytest test_server.py

      - name: Run stress tests
        run: python3 stress_test.py

      - name: Stop server running in background
        run: pkill -f server.py || true

    # This job will deploy to a staging environment after tests pass
  deploy-to-staging:
    needs: test # This ensures deployment only runs after tests pass
    runs-on: ubuntu-latest # Or a specific runner for staging environment
    environment:
      name: staging
      url: http://127.0.0.1:8790 # Optional: URL to your staging environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # If your build artifact is from the 'test' job, you'd download it here
        # - name: Download build artifact
        #   uses: actions/download-artifact@v4
        #   with:
        #     name: my-app-build

      - name: Deploy to Staging Environment
        run: |
          echo "Deploying to staging..."
          # Your deployment commands go here
          # This might involve:
          # - Copying files to a server (e.g., using scp, rsync)
          # - Running a deployment script (e.g., Ansible, custom shell script)
          # - Using an AWS CLI command (e.g., for S3 sync, CodeDeploy deployment)
          # - Logging into a cloud provider and deploying (e.g., `aws deploy`, `gcloud deploy`)

          # Example: A placeholder for actual deployment commands
          echo "Deployment to staging complete!"
